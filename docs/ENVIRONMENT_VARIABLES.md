# Environment Variables Reference (`.env`)

This project uses a `.env` file for **secrets** and **environment-specific wiring** (ARI connection, API keys, host/network knobs, logging, etc.). Most runtime behavior (transport mode, pipelines, providers, barge-in, streaming) lives in `config/ai-agent.yaml`.

For the full, commented list of variables, see `.env.example` (copy it to `.env`).

## How `.env` is applied

- Docker Compose loads `.env` as an `env_file` for containers.
- The Admin UI reads and writes `.env` (Setup Wizard and Environment pages).
- Changing `.env` typically requires **recreating** containers to take effect (a plain restart may not reload `env_file` values).

## Required for a first successful call

Set these in `.env`:

- `ASTERISK_HOST`, `ASTERISK_ARI_PORT` (optional), `ASTERISK_ARI_USERNAME`, `ASTERISK_ARI_PASSWORD`
- Provider keys for whatever you enable:
  - `OPENAI_API_KEY`
  - `DEEPGRAM_API_KEY`
  - `GOOGLE_API_KEY` (or `GOOGLE_APPLICATION_CREDENTIALS`)
  - `ELEVENLABS_API_KEY` + `ELEVENLABS_AGENT_ID`
- `JWT_SECRET` (generated by `preflight.sh` / `install.sh`; required for Admin UI auth stability)

## Common operator variables

### Asterisk ARI

- `ASTERISK_HOST`: where `ai_engine` reaches ARI (IP/hostname).
- `ASTERISK_ARI_PORT`: ARI port (default `8088`).
- `ASTERISK_ARI_USERNAME` / `ASTERISK_ARI_PASSWORD`: ARI credentials (secrets).
- `ASTERISK_UID` / `ASTERISK_GID`: align container permissions with your Asterisk user/group (needed for shared media mounts on some hosts).

### Provider credentials (env-only)

Provider `api_key` values in YAML are intentionally ignored for safety; set keys in `.env` instead:

- OpenAI: `OPENAI_API_KEY`
- Deepgram: `DEEPGRAM_API_KEY`
- Google Live / Google adapters: `GOOGLE_API_KEY` or `GOOGLE_APPLICATION_CREDENTIALS`
- ElevenLabs: `ELEVENLABS_API_KEY`, `ELEVENLABS_AGENT_ID`

### Email delivery (Resend or SMTP)

Email tools (`send_email_summary`, `request_transcript`) support:

- Resend: `RESEND_API_KEY`
- SMTP (local mail server):
  - `SMTP_HOST`, `SMTP_PORT`
  - `SMTP_USERNAME`, `SMTP_PASSWORD`
  - `SMTP_TLS_MODE` (`starttls` / `smtps` / `none`)
  - `SMTP_TLS_VERIFY` (`true` / `false`)
  - `SMTP_TIMEOUT_SECONDS`

Secrets (API keys / SMTP passwords) belong in `.env` and should never be committed.

### Transport / networking

These are used when Asterisk and containers are not on the same host/network (NAT/bridged Docker):

- `AUDIOSOCKET_ADVERTISE_HOST`: public/LAN IP that Asterisk should use to reach the AudioSocket listener.
- `EXTERNAL_MEDIA_ADVERTISE_HOST`: public/LAN IP that Asterisk should use to reach ExternalMedia RTP.

If you’re not sure, start without these; use `agent check` and `docs/Transport-Mode-Compatibility.md` for validation guidance.

### Health endpoints (bind / probe)

- `HEALTH_BIND_HOST`, `HEALTH_BIND_PORT`: where `ai_engine` binds `/live`, `/ready`, `/health`, `/metrics`.
- `HEALTH_CHECK_AI_ENGINE_URL`: optional override used by Admin UI for Tier-3 / non-host-network deployments.
- `HEALTH_CHECK_LOCAL_AI_URL`: optional override used by Admin UI for Local AI Server probes.

### Admin UI / Docker socket

- `DOCKER_SOCK`: rootless docker socket path (if not `/var/run/docker.sock`).
- `DOCKER_GID`: docker socket group id (Admin UI needs it to manage containers).
- `ADMIN_UI_CORS_ORIGINS`: restrict allowed origins for Admin UI API.

### Local AI Server (local pipelines)

- `LOCAL_WS_URL`: how `ai_engine` reaches `local_ai_server` (host networking default is `ws://127.0.0.1:8765`).
- `LOCAL_WS_AUTH_TOKEN`: optional auth token (recommended if you bind `local_ai_server` to non-loopback).
- `LOCAL_STT_BACKEND`, `LOCAL_TTS_BACKEND`, `LOCAL_AI_MODE`: local runtime/backends (see `.env.example` for the full matrix).

### Call History / storage

- `CALL_HISTORY_DB_PATH`: SQLite path for Call History (default in `.env.example` is `data/call_history.db`).
- `CALL_HISTORY_RETENTION_DAYS`: retention (0 = keep indefinitely).

### Logging / diagnostics

- `LOG_LEVEL`, `LOG_FORMAT`, `STREAMING_LOG_LEVEL`: tune verbosity per environment.
- `DIAG_ENABLE_TAPS`: enable streaming diagnostic taps (writes under `/tmp` by default; see `config/ai-agent.yaml` `streaming.diag_*`).

## Outbound calling (alpha)

If you use **Admin UI → Call Scheduling**:

- `AAVA_OUTBOUND_EXTENSION_IDENTITY`
- `AAVA_OUTBOUND_AMD_CONTEXT`
- `AAVA_MEDIA_DIR`
- `AAVA_SERVER_TIMEZONE` (optional override; otherwise `TZ`)

## Where to change “behavior”

- Transport mode / pipelines / providers / barge-in / streaming: `config/ai-agent.yaml`
- Secrets + host wiring + operational knobs: `.env`
