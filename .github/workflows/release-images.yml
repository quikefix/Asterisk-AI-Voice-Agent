name: Release Images (GHCR)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"
      - "[0-9]*.[0-9]*.[0-9]*"

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute tags
        id: meta
        run: |
          TAG="${GITHUB_REF_NAME}"
          OWNER="${GITHUB_REPOSITORY_OWNER,,}"
          VERSION="${TAG#v}"

          # Only publish :latest for clean GA semver tags (no "-rc", "-beta", etc.).
          PUBLISH_LATEST=false
          if [[ "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            PUBLISH_LATEST=true
          fi

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "owner=${OWNER}" >> "$GITHUB_OUTPUT"
          echo "publish_latest=${PUBLISH_LATEST}" >> "$GITHUB_OUTPUT"

          {
            echo "ai_engine_tags<<EOF"
            echo "ghcr.io/${OWNER}/asterisk-ai-voice-agent-ai-engine:${TAG}"
            if [ "$PUBLISH_LATEST" = "true" ]; then
              echo "ghcr.io/${OWNER}/asterisk-ai-voice-agent-ai-engine:latest"
            fi
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          {
            echo "local_ai_server_tags<<EOF"
            echo "ghcr.io/${OWNER}/asterisk-ai-voice-agent-local-ai-server:${TAG}"
            if [ "$PUBLISH_LATEST" = "true" ]; then
              echo "ghcr.io/${OWNER}/asterisk-ai-voice-agent-local-ai-server:latest"
            fi
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          {
            echo "admin_ui_tags<<EOF"
            echo "ghcr.io/${OWNER}/asterisk-ai-voice-agent-admin-ui:${TAG}"
            if [ "$PUBLISH_LATEST" = "true" ]; then
              echo "ghcr.io/${OWNER}/asterisk-ai-voice-agent-admin-ui:latest"
            fi
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          {
            echo "updater_tags<<EOF"
            echo "ghcr.io/${OWNER}/asterisk-ai-voice-agent-updater:${TAG}"
            if [ "$PUBLISH_LATEST" = "true" ]; then
              echo "ghcr.io/${OWNER}/asterisk-ai-voice-agent-updater:latest"
            fi
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Build and push ai-engine
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.ai_engine_tags }}

      # Publish a “core” local-ai-server profile (no optional heavy backends).
      # Models are NOT bundled; users mount/download models separately.
      - name: Build and push local-ai-server (core)
        uses: docker/build-push-action@v6
        with:
          context: ./local_ai_server
          file: ./local_ai_server/Dockerfile
          push: true
          build-args: |
            INCLUDE_VOSK=true
            INCLUDE_SHERPA=false
            INCLUDE_PIPER=true
            INCLUDE_KOKORO=false
            INCLUDE_LLAMA=true
            INCLUDE_KROKO_EMBEDDED=false
          tags: ${{ steps.meta.outputs.local_ai_server_tags }}

      - name: Build and push admin-ui
        uses: docker/build-push-action@v6
        with:
          context: ./admin_ui
          file: ./admin_ui/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.admin_ui_tags }}

      - name: Build and push updater
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./updater/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.updater_tags }}
